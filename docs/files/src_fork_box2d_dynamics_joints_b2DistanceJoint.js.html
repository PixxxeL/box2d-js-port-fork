<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\fork\box2d\dynamics\joints\b2DistanceJoint.js - Box2D Port Fork API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Box2D Port Fork API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/b2AABB.html">b2AABB</a></li>
            
                <li><a href="../classes/b2Body.html">b2Body</a></li>
            
                <li><a href="../classes/b2BodyDef.html">b2BodyDef</a></li>
            
                <li><a href="../classes/b2Bound.html">b2Bound</a></li>
            
                <li><a href="../classes/b2BoundValues.html">b2BoundValues</a></li>
            
                <li><a href="../classes/b2BoxDef.html">b2BoxDef</a></li>
            
                <li><a href="../classes/b2BufferedPair.html">b2BufferedPair</a></li>
            
                <li><a href="../classes/b2CircleContact.html">b2CircleContact</a></li>
            
                <li><a href="../classes/b2CircleDef.html">b2CircleDef</a></li>
            
                <li><a href="../classes/b2CircleShape.html">b2CircleShape</a></li>
            
                <li><a href="../classes/b2Collision.html">b2Collision</a></li>
            
                <li><a href="../classes/b2CollisionFilter.html">b2CollisionFilter</a></li>
            
                <li><a href="../classes/b2Conservative.html">b2Conservative</a></li>
            
                <li><a href="../classes/b2Contact.html">b2Contact</a></li>
            
                <li><a href="../classes/b2ContactConstraint.html">b2ContactConstraint</a></li>
            
                <li><a href="../classes/b2ContactConstraintPoint.html">b2ContactConstraintPoint</a></li>
            
                <li><a href="../classes/b2ContactID.html">b2ContactID</a></li>
            
                <li><a href="../classes/b2ContactManager.html">b2ContactManager</a></li>
            
                <li><a href="../classes/b2ContactNode.html">b2ContactNode</a></li>
            
                <li><a href="../classes/b2ContactPoint.html">b2ContactPoint</a></li>
            
                <li><a href="../classes/b2ContactRegister.html">b2ContactRegister</a></li>
            
                <li><a href="../classes/b2ContactSolver.html">b2ContactSolver</a></li>
            
                <li><a href="../classes/b2Distance.html">b2Distance</a></li>
            
                <li><a href="../classes/b2DistanceJoint.html">b2DistanceJoint</a></li>
            
                <li><a href="../classes/b2DistanceJointDef.html">b2DistanceJointDef</a></li>
            
                <li><a href="../classes/b2GearJoint.html">b2GearJoint</a></li>
            
                <li><a href="../classes/b2GearJointDef.html">b2GearJointDef</a></li>
            
                <li><a href="../classes/b2Island.html">b2Island</a></li>
            
                <li><a href="../classes/b2Jacobian.html">b2Jacobian</a></li>
            
                <li><a href="../classes/b2Joint.html">b2Joint</a></li>
            
                <li><a href="../classes/b2JointDef.html">b2JointDef</a></li>
            
                <li><a href="../classes/b2JointNode.html">b2JointNode</a></li>
            
                <li><a href="../classes/b2Manifold.html">b2Manifold</a></li>
            
                <li><a href="../classes/b2MassData.html">b2MassData</a></li>
            
                <li><a href="../classes/b2Mat22.html">b2Mat22</a></li>
            
                <li><a href="../classes/b2Math.html">b2Math</a></li>
            
                <li><a href="../classes/b2MouseJoint.html">b2MouseJoint</a></li>
            
                <li><a href="../classes/b2MouseJointDef.html">b2MouseJointDef</a></li>
            
                <li><a href="../classes/b2NullContact.html">b2NullContact</a></li>
            
                <li><a href="../classes/b2OBB.html">b2OBB</a></li>
            
                <li><a href="../classes/b2Pair.html">b2Pair</a></li>
            
                <li><a href="../classes/b2PairCallback.html">b2PairCallback</a></li>
            
                <li><a href="../classes/b2PairManager.html">b2PairManager</a></li>
            
                <li><a href="../classes/b2PolyAndCircleContact.html">b2PolyAndCircleContact</a></li>
            
                <li><a href="../classes/b2PolyContact.html">b2PolyContact</a></li>
            
                <li><a href="../classes/b2PolyDef.html">b2PolyDef</a></li>
            
                <li><a href="../classes/b2PolyShape.html">b2PolyShape</a></li>
            
                <li><a href="../classes/b2PrismaticJoint.html">b2PrismaticJoint</a></li>
            
                <li><a href="../classes/b2PrismaticJointDef.html">b2PrismaticJointDef</a></li>
            
                <li><a href="../classes/b2Proxy.html">b2Proxy</a></li>
            
                <li><a href="../classes/b2PulleyJoint.html">b2PulleyJoint</a></li>
            
                <li><a href="../classes/b2PulleyJointDef.html">b2PulleyJointDef</a></li>
            
                <li><a href="../classes/b2RevoluteJoint.html">b2RevoluteJoint</a></li>
            
                <li><a href="../classes/b2RevoluteJointDef.html">b2RevoluteJointDef</a></li>
            
                <li><a href="../classes/b2Settings.html">b2Settings</a></li>
            
                <li><a href="../classes/b2Shape.html">b2Shape</a></li>
            
                <li><a href="../classes/b2ShapeDef.html">b2ShapeDef</a></li>
            
                <li><a href="../classes/b2TimeStep.html">b2TimeStep</a></li>
            
                <li><a href="../classes/b2Vec2.html">b2Vec2</a></li>
            
                <li><a href="../classes/b2World.html">b2World</a></li>
            
                <li><a href="../classes/b2WorldListener.html">b2WorldListener</a></li>
            
                <li><a href="../classes/ClipVertex.html">ClipVertex</a></li>
            
                <li><a href="../classes/Features.html">Features</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\fork\box2d\dynamics\joints\b2DistanceJoint.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/*
* Copyright (c) 2006-2007 Erin Catto http:
*
* This software is provided &#x27;as-is&#x27;, without any express or implied
* warranty.  In no event will the authors be held liable for any damages
* arising from the use of this software.
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
* 1. The origin of this software must not be misrepresented; you must not
* claim that you wrote the original software. If you use this software
* in a product, an acknowledgment in the product documentation would be
* appreciated but is not required.
* 2. Altered source versions must be plainly marked, and must not be
* misrepresented the original software.
* 3. This notice may not be removed or altered from any source distribution.
*/

/**
 * C = norm(p2 - p1) - L
 * u = (p2 - p1) / norm(p2 - p1)
 * Cdot = dot(u, v2 + cross(w2, r2) - v1 - cross(w1, r1))
 * J = [-u -cross(r1, u) u cross(r2, u)]
 * K = J * invM * JT
 *   = invMass1 + invI1 * cross(r1, u)^2 + invMass2 + invI2 * cross(r2, u)^2
 * 
 * @class b2DistanceJoint
 * @constructor
 */
var b2DistanceJoint = function (def) {
    // The constructor for b2Joint
	// initialize instance variables for references
	this.m_node1 = new b2JointNode();
	this.m_node2 = new b2JointNode();
	//
	this.m_type = def.type;
	this.m_prev = null;
	this.m_next = null;
	this.m_body1 = def.body1;
	this.m_body2 = def.body2;
	this.m_collideConnected = def.collideConnected;
	this.m_islandFlag = false;
	this.m_userData = def.userData;
	//

	// initialize instance variables for references
	this.m_localAnchor1 = new b2Vec2();
	this.m_localAnchor2 = new b2Vec2();
	this.m_u = new b2Vec2();
	//

	//super(def);

	var tMat;
	var tX;
	var tY;
	//this.m_localAnchor1 = b2MulT(this.m_body1-&gt;m_R, def-&gt;anchorPoint1 - this.m_body1-&gt;m_position);
	tMat = this.m_body1.m_R;
	tX = def.anchorPoint1.x - this.m_body1.m_position.x;
	tY = def.anchorPoint1.y - this.m_body1.m_position.y;
	this.m_localAnchor1.x = tX*tMat.col1.x + tY*tMat.col1.y;
	this.m_localAnchor1.y = tX*tMat.col2.x + tY*tMat.col2.y;
	//this.m_localAnchor2 = b2MulT(this.m_body2-&gt;m_R, def-&gt;anchorPoint2 - this.m_body2-&gt;m_position);
	tMat = this.m_body2.m_R;
	tX = def.anchorPoint2.x - this.m_body2.m_position.x;
	tY = def.anchorPoint2.y - this.m_body2.m_position.y;
	this.m_localAnchor2.x = tX*tMat.col1.x + tY*tMat.col1.y;
	this.m_localAnchor2.y = tX*tMat.col2.x + tY*tMat.col2.y;

	//b2Vec2 d = def-&gt;anchorPoint2 - def-&gt;anchorPoint1;
	tX = def.anchorPoint2.x - def.anchorPoint1.x;
	tY = def.anchorPoint2.y - def.anchorPoint1.y;
	//this.m_length = d.Length();
	this.m_length = Math.sqrt(tX*tX + tY*tY);
	this.m_impulse = 0.0;
};
Object.extend(b2DistanceJoint.prototype, b2Joint.prototype);
Object.extend(b2DistanceJoint.prototype, 
{
	//--------------- Internals Below -------------------

	PrepareVelocitySolver: function(){

		var tMat;

		// Compute the effective mass matrix.
		//b2Vec2 r1 = b2Mul(this.m_body1-&gt;m_R, this.m_localAnchor1);
		tMat = this.m_body1.m_R;
		var r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;
		var r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;
		//b2Vec2 r2 = b2Mul(this.m_body2-&gt;m_R, this.m_localAnchor2);
		tMat = this.m_body2.m_R;
		var r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;
		var r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;
		//this.m_u = this.m_body2-&gt;m_position + r2 - this.m_body1-&gt;m_position - r1;
		this.m_u.x = this.m_body2.m_position.x + r2X - this.m_body1.m_position.x - r1X;
		this.m_u.y = this.m_body2.m_position.y + r2Y - this.m_body1.m_position.y - r1Y;

		// Handle singularity.
		//float32 length = this.m_u.Length();
		var length = Math.sqrt(this.m_u.x*this.m_u.x + this.m_u.y*this.m_u.y);
		if (length &gt; b2Settings.b2_linearSlop)
		{
			//this.m_u *= 1.0 / length;
			this.m_u.Multiply( 1.0 / length );
		}
		else
		{
			this.m_u.SetZero();
		}

		//float32 cr1u = b2Cross(r1, this.m_u);
		var cr1u = (r1X * this.m_u.y - r1Y * this.m_u.x);
		//float32 cr2u = b2Cross(r2, this.m_u);
		var cr2u = (r2X * this.m_u.y - r2Y * this.m_u.x);
		//this.m_mass = this.m_body1-&gt;m_invMass + this.m_body1-&gt;m_invI * cr1u * cr1u + this.m_body2-&gt;m_invMass + this.m_body2-&gt;m_invI * cr2u * cr2u;
		this.m_mass = this.m_body1.m_invMass + this.m_body1.m_invI * cr1u * cr1u + this.m_body2.m_invMass + this.m_body2.m_invI * cr2u * cr2u;
		//b2Settings.b2Assert(this.m_mass &gt; Number.MIN_VALUE);
		this.m_mass = 1.0 / this.m_mass;

		if (b2World.s_enableWarmStarting)
		{
			//b2Vec2 P = this.m_impulse * this.m_u;
			var PX = this.m_impulse * this.m_u.x;
			var PY = this.m_impulse * this.m_u.y;
			//this.m_body1.m_linearVelocity -= this.m_body1.m_invMass * P;
			this.m_body1.m_linearVelocity.x -= this.m_body1.m_invMass * PX;
			this.m_body1.m_linearVelocity.y -= this.m_body1.m_invMass * PY;
			//this.m_body1.m_angularVelocity -= this.m_body1.m_invI * b2Cross(r1, P);
			this.m_body1.m_angularVelocity -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);
			//this.m_body2.m_linearVelocity += this.m_body2.m_invMass * P;
			this.m_body2.m_linearVelocity.x += this.m_body2.m_invMass * PX;
			this.m_body2.m_linearVelocity.y += this.m_body2.m_invMass * PY;
			//this.m_body2.m_angularVelocity += this.m_body2.m_invI * b2Cross(r2, P);
			this.m_body2.m_angularVelocity += this.m_body2.m_invI * (r2X * PY - r2Y * PX);
		}
		else
		{
			this.m_impulse = 0.0;
		}

	},



	SolveVelocityConstraints: function(step){

		var tMat;

		//b2Vec2 r1 = b2Mul(this.m_body1-&gt;m_R, this.m_localAnchor1);
		tMat = this.m_body1.m_R;
		var r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;
		var r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;
		//b2Vec2 r2 = b2Mul(this.m_body2-&gt;m_R, this.m_localAnchor2);
		tMat = this.m_body2.m_R;
		var r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;
		var r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;

		// Cdot = dot(u, v + cross(w, r))
		//b2Vec2 v1 = this.m_body1-&gt;m_linearVelocity + b2Cross(this.m_body1-&gt;m_angularVelocity, r1);
		var v1X = this.m_body1.m_linearVelocity.x + (-this.m_body1.m_angularVelocity * r1Y);
		var v1Y = this.m_body1.m_linearVelocity.y + (this.m_body1.m_angularVelocity * r1X);
		//b2Vec2 v2 = this.m_body2-&gt;m_linearVelocity + b2Cross(this.m_body2-&gt;m_angularVelocity, r2);
		var v2X = this.m_body2.m_linearVelocity.x + (-this.m_body2.m_angularVelocity * r2Y);
		var v2Y = this.m_body2.m_linearVelocity.y + (this.m_body2.m_angularVelocity * r2X);
		//float32 Cdot = b2Dot(this.m_u, v2 - v1);
		var Cdot = (this.m_u.x * (v2X - v1X) + this.m_u.y * (v2Y - v1Y));
		//float32 impulse = -this.m_mass * Cdot;
		var impulse = -this.m_mass * Cdot;
		this.m_impulse += impulse;

		//b2Vec2 P = impulse * this.m_u;
		var PX = impulse * this.m_u.x;
		var PY = impulse * this.m_u.y;
		//this.m_body1-&gt;m_linearVelocity -= this.m_body1-&gt;m_invMass * P;
		this.m_body1.m_linearVelocity.x -= this.m_body1.m_invMass * PX;
		this.m_body1.m_linearVelocity.y -= this.m_body1.m_invMass * PY;
		//this.m_body1-&gt;m_angularVelocity -= this.m_body1-&gt;m_invI * b2Cross(r1, P);
		this.m_body1.m_angularVelocity -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);
		//this.m_body2-&gt;m_linearVelocity += this.m_body2-&gt;m_invMass * P;
		this.m_body2.m_linearVelocity.x += this.m_body2.m_invMass * PX;
		this.m_body2.m_linearVelocity.y += this.m_body2.m_invMass * PY;
		//this.m_body2-&gt;m_angularVelocity += this.m_body2-&gt;m_invI * b2Cross(r2, P);
		this.m_body2.m_angularVelocity += this.m_body2.m_invI * (r2X * PY - r2Y * PX);
	},

	SolvePositionConstraints: function(){

		var tMat;

		//b2Vec2 r1 = b2Mul(this.m_body1-&gt;m_R, this.m_localAnchor1);
		tMat = this.m_body1.m_R;
		var r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;
		var r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;
		//b2Vec2 r2 = b2Mul(this.m_body2-&gt;m_R, this.m_localAnchor2);
		tMat = this.m_body2.m_R;
		var r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;
		var r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;
		//b2Vec2 d = this.m_body2-&gt;m_position + r2 - this.m_body1-&gt;m_position - r1;
		var dX = this.m_body2.m_position.x + r2X - this.m_body1.m_position.x - r1X;
		var dY = this.m_body2.m_position.y + r2Y - this.m_body1.m_position.y - r1Y;

		//float32 length = d.Normalize();
		var length = Math.sqrt(dX*dX + dY*dY);
		dX /= length;
		dY /= length;
		//float32 C = length - this.m_length;
		var C = length - this.m_length;
		C = b2Math.b2Clamp(C, -b2Settings.b2_maxLinearCorrection, b2Settings.b2_maxLinearCorrection);

		var impulse = -this.m_mass * C;
		//this.m_u = d;
		this.m_u.Set(dX, dY);
		//b2Vec2 P = impulse * this.m_u;
		var PX = impulse * this.m_u.x;
		var PY = impulse * this.m_u.y;

		//this.m_body1-&gt;m_position -= this.m_body1-&gt;m_invMass * P;
		this.m_body1.m_position.x -= this.m_body1.m_invMass * PX;
		this.m_body1.m_position.y -= this.m_body1.m_invMass * PY;
		//this.m_body1-&gt;m_rotation -= this.m_body1-&gt;m_invI * b2Cross(r1, P);
		this.m_body1.m_rotation -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);
		//this.m_body2-&gt;m_position += this.m_body2-&gt;m_invMass * P;
		this.m_body2.m_position.x += this.m_body2.m_invMass * PX;
		this.m_body2.m_position.y += this.m_body2.m_invMass * PY;
		//this.m_body2-&gt;m_rotation -= this.m_body2-&gt;m_invI * b2Cross(r2, P);
		this.m_body2.m_rotation += this.m_body2.m_invI * (r2X * PY - r2Y * PX);

		this.m_body1.m_R.Set(this.m_body1.m_rotation);
		this.m_body2.m_R.Set(this.m_body2.m_rotation);

		return b2Math.b2Abs(C) &lt; b2Settings.b2_linearSlop;

	},

	GetAnchor1: function(){
		return b2Math.AddVV(this.m_body1.m_position , b2Math.b2MulMV(this.m_body1.m_R, this.m_localAnchor1));
	},
	GetAnchor2: function(){
		return b2Math.AddVV(this.m_body2.m_position , b2Math.b2MulMV(this.m_body2.m_R, this.m_localAnchor2));
	},

	GetReactionForce: function(invTimeStep)
	{
		//var F = (this.m_impulse * invTimeStep) * this.m_u;
		var F = new b2Vec2();
		F.SetV(this.m_u);
		F.Multiply(this.m_impulse * invTimeStep);
		return F;
	},

	GetReactionTorque: function(invTimeStep)
	{
		//NOT_USED(invTimeStep);
		return 0.0;
	},

	m_localAnchor1: new b2Vec2(),
	m_localAnchor2: new b2Vec2(),
	m_u: new b2Vec2(),
	m_impulse: null,
	m_mass: null,
	m_length: null
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
