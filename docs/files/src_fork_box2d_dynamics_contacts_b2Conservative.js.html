<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\fork\box2d\dynamics\contacts\b2Conservative.js - Box2D Port Fork API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Box2D Port Fork API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/b2AABB.html">b2AABB</a></li>
            
                <li><a href="../classes/b2Body.html">b2Body</a></li>
            
                <li><a href="../classes/b2BodyDef.html">b2BodyDef</a></li>
            
                <li><a href="../classes/b2Bound.html">b2Bound</a></li>
            
                <li><a href="../classes/b2BoundValues.html">b2BoundValues</a></li>
            
                <li><a href="../classes/b2BoxDef.html">b2BoxDef</a></li>
            
                <li><a href="../classes/b2BufferedPair.html">b2BufferedPair</a></li>
            
                <li><a href="../classes/b2CircleContact.html">b2CircleContact</a></li>
            
                <li><a href="../classes/b2CircleDef.html">b2CircleDef</a></li>
            
                <li><a href="../classes/b2CircleShape.html">b2CircleShape</a></li>
            
                <li><a href="../classes/b2Collision.html">b2Collision</a></li>
            
                <li><a href="../classes/b2CollisionFilter.html">b2CollisionFilter</a></li>
            
                <li><a href="../classes/b2Conservative.html">b2Conservative</a></li>
            
                <li><a href="../classes/b2Contact.html">b2Contact</a></li>
            
                <li><a href="../classes/b2ContactConstraint.html">b2ContactConstraint</a></li>
            
                <li><a href="../classes/b2ContactConstraintPoint.html">b2ContactConstraintPoint</a></li>
            
                <li><a href="../classes/b2ContactID.html">b2ContactID</a></li>
            
                <li><a href="../classes/b2ContactManager.html">b2ContactManager</a></li>
            
                <li><a href="../classes/b2ContactNode.html">b2ContactNode</a></li>
            
                <li><a href="../classes/b2ContactPoint.html">b2ContactPoint</a></li>
            
                <li><a href="../classes/b2ContactRegister.html">b2ContactRegister</a></li>
            
                <li><a href="../classes/b2ContactSolver.html">b2ContactSolver</a></li>
            
                <li><a href="../classes/b2Distance.html">b2Distance</a></li>
            
                <li><a href="../classes/b2DistanceJoint.html">b2DistanceJoint</a></li>
            
                <li><a href="../classes/b2DistanceJointDef.html">b2DistanceJointDef</a></li>
            
                <li><a href="../classes/b2GearJoint.html">b2GearJoint</a></li>
            
                <li><a href="../classes/b2GearJointDef.html">b2GearJointDef</a></li>
            
                <li><a href="../classes/b2Island.html">b2Island</a></li>
            
                <li><a href="../classes/b2Jacobian.html">b2Jacobian</a></li>
            
                <li><a href="../classes/b2Joint.html">b2Joint</a></li>
            
                <li><a href="../classes/b2JointDef.html">b2JointDef</a></li>
            
                <li><a href="../classes/b2JointNode.html">b2JointNode</a></li>
            
                <li><a href="../classes/b2Manifold.html">b2Manifold</a></li>
            
                <li><a href="../classes/b2MassData.html">b2MassData</a></li>
            
                <li><a href="../classes/b2Mat22.html">b2Mat22</a></li>
            
                <li><a href="../classes/b2Math.html">b2Math</a></li>
            
                <li><a href="../classes/b2MouseJoint.html">b2MouseJoint</a></li>
            
                <li><a href="../classes/b2MouseJointDef.html">b2MouseJointDef</a></li>
            
                <li><a href="../classes/b2NullContact.html">b2NullContact</a></li>
            
                <li><a href="../classes/b2OBB.html">b2OBB</a></li>
            
                <li><a href="../classes/b2Pair.html">b2Pair</a></li>
            
                <li><a href="../classes/b2PairCallback.html">b2PairCallback</a></li>
            
                <li><a href="../classes/b2PairManager.html">b2PairManager</a></li>
            
                <li><a href="../classes/b2PolyAndCircleContact.html">b2PolyAndCircleContact</a></li>
            
                <li><a href="../classes/b2PolyContact.html">b2PolyContact</a></li>
            
                <li><a href="../classes/b2PolyDef.html">b2PolyDef</a></li>
            
                <li><a href="../classes/b2PolyShape.html">b2PolyShape</a></li>
            
                <li><a href="../classes/b2PrismaticJoint.html">b2PrismaticJoint</a></li>
            
                <li><a href="../classes/b2PrismaticJointDef.html">b2PrismaticJointDef</a></li>
            
                <li><a href="../classes/b2Proxy.html">b2Proxy</a></li>
            
                <li><a href="../classes/b2PulleyJoint.html">b2PulleyJoint</a></li>
            
                <li><a href="../classes/b2PulleyJointDef.html">b2PulleyJointDef</a></li>
            
                <li><a href="../classes/b2RevoluteJoint.html">b2RevoluteJoint</a></li>
            
                <li><a href="../classes/b2RevoluteJointDef.html">b2RevoluteJointDef</a></li>
            
                <li><a href="../classes/b2Settings.html">b2Settings</a></li>
            
                <li><a href="../classes/b2Shape.html">b2Shape</a></li>
            
                <li><a href="../classes/b2ShapeDef.html">b2ShapeDef</a></li>
            
                <li><a href="../classes/b2TimeStep.html">b2TimeStep</a></li>
            
                <li><a href="../classes/b2Vec2.html">b2Vec2</a></li>
            
                <li><a href="../classes/b2World.html">b2World</a></li>
            
                <li><a href="../classes/b2WorldListener.html">b2WorldListener</a></li>
            
                <li><a href="../classes/ClipVertex.html">ClipVertex</a></li>
            
                <li><a href="../classes/Features.html">Features</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src\fork\box2d\dynamics\contacts\b2Conservative.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/*
* Copyright (c) 2006-2007 Erin Catto http:
*
* This software is provided &#x27;as-is&#x27;, without any express or implied
* warranty.  In no event will the authors be held liable for any damages
* arising from the use of this software.
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
* 1. The origin of this software must not be misrepresented; you must not
* claim that you wrote the original software. If you use this software
* in a product, an acknowledgment in the product documentation would be
* appreciated but is not required.
* 2. Altered source versions must be plainly marked, and must not be
* misrepresented the original software.
* 3. This notice may not be removed or altered from any source distribution.
*/




/**
 * @class b2Conservative
 * @constructor
 */
var b2Conservative = function () {
    //
};
b2Conservative.prototype = {
	// Temp vars
};

b2Conservative.R1 = new b2Mat22();
b2Conservative.R2 = new b2Mat22();
b2Conservative.x1 = new b2Vec2();
b2Conservative.x2 = new b2Vec2();

b2Conservative.Conservative = function (shape1, shape2) {
	var body1 = shape1.GetBody();
	var body2 = shape2.GetBody();

	//b2Vec2 v1 = body1-&gt;m_position - body1-&gt;m_position0;
	var v1X = body1.m_position.x - body1.m_position0.x;
	var v1Y = body1.m_position.y - body1.m_position0.y;
	//float32 omega1 = body1-&gt;m_rotation - body1-&gt;m_rotation0;
	var omega1 = body1.m_rotation - body1.m_rotation0;
	//b2Vec2 v2 = body2-&gt;m_position - body2-&gt;m_position0;
	var v2X = body2.m_position.x - body2.m_position0.x;
	var v2Y = body2.m_position.y - body2.m_position0.y;
	//float32 omega2 = body2-&gt;m_rotation - body2-&gt;m_rotation0;
	var omega2 = body2.m_rotation - body2.m_rotation0;

	//float32 r1 = shape1-&gt;GetMaxRadius();
	var r1 = shape1.GetMaxRadius();
	//float32 r2 = shape2-&gt;GetMaxRadius();
	var r2 = shape2.GetMaxRadius();

	//b2Vec2 p1Start = body1-&gt;m_position0;
	var p1StartX = body1.m_position0.x;
	var p1StartY = body1.m_position0.y;
	//float32 a1Start = body1-&gt;m_rotation0;
	var a1Start = body1.m_rotation0;

	//b2Vec2 p2Start = body2-&gt;m_position0;
	var p2StartX = body2.m_position0.x;
	var p2StartY = body2.m_position0.y;
	//float32 a2Start = body2-&gt;m_rotation0;
	var a2Start = body2.m_rotation0;

	//b2Vec2 p1 = p1Start;
	var p1X = p1StartX;
	var p1Y = p1StartY;
	//float32 a1 = a1Start;
	var a1 = a1Start;
	//b2Vec2 p2 = p2Start;
	var p2X = p2StartX;
	var p2Y = p2StartY;
	//float32 a2 = a2Start;
	var a2 = a2Start;

	//b2Mat22 b2Conservative.R1(a1), b2Conservative.R2(a2);
	b2Conservative.R1.Set(a1);
	b2Conservative.R2.Set(a2);

	//shape1-&gt;QuickSync(p1, b2Conservative.R1);
	shape1.QuickSync(p1, b2Conservative.R1);
	//shape2-&gt;QuickSync(p2, b2Conservative.R2);
	shape2.QuickSync(p2, b2Conservative.R2);

	//float32 s1 = 0.0f;
	var s1 = 0.0;
	//const int32 maxIterations = 10;
	var maxIterations = 10;
	//b2Vec2 d;
	var dX;
	var dY;
	//float32 invRelativeVelocity = 0.0f;
	var invRelativeVelocity = 0.0;
	//bool hit = true;
	var hit = true;
	//b2Vec2 b2Conservative.x1, b2Conservative.x2; moved to static var
	for (var iter = 0; iter &lt; maxIterations; ++iter)
	{
		// Get the accurate distance between shapes.
		//float32 distance = b2Distance.Distance(&amp;b2Conservative.x1, &amp;b2Conservative.x2, shape1, shape2);
		var distance = b2Distance.Distance(b2Conservative.x1, b2Conservative.x2, shape1, shape2);
		if (distance &lt; b2Settings.b2_linearSlop)
		{
			if (iter == 0)
			{
				hit = false;
			}
			else
			{
				hit = true;
			}
			break;
		}

		if (iter == 0)
		{
			//b2Vec2 d = b2Conservative.x2 - b2Conservative.x1;
			dX = b2Conservative.x2.x - b2Conservative.x1.x;
			dY = b2Conservative.x2.y - b2Conservative.x1.y;
			//d.Normalize();
			var dLen = Math.sqrt(dX*dX + dY*dY);
			//float32 relativeVelocity = b2Dot(d, v1 - v2) + b2Abs(omega1) * r1 + b2Abs(omega2) * r2;
			var relativeVelocity = (dX*(v1X-v2X) + dY*(v1Y - v2Y)) + Math.abs(omega1) * r1 + Math.abs(omega2) * r2;
			if (Math.abs(relativeVelocity) &lt; Number.MIN_VALUE)
			{
				hit = false;
				break;
			}

			invRelativeVelocity = 1.0 / relativeVelocity;
		}

		// Get the conservative movement.
		//float32 ds = distance * invRelativeVelocity;
		var ds = distance * invRelativeVelocity;
		//float32 s2 = s1 + ds;
		var s2 = s1 + ds;

		if (s2 &lt; 0.0 || 1.0 &lt; s2)
		{
			hit = false;
			break;
		}

		if (s2 &lt; (1.0 + 100.0 * Number.MIN_VALUE) * s1)
		{
			hit = true;
			break;
		}

		s1 = s2;

		// Move forward conservatively.
		//p1 = p1Start + s1 * v1;
		p1X = p1StartX + s1 * v1.x;
		p1Y = p1StartY + s1 * v1.y;
		//a1 = a1Start + s1 * omega1;
		a1 = a1Start + s1 * omega1;
		//p2 = p2Start + s1 * v2;
		p2X = p2StartX + s1 * v2.x;
		p2Y = p2StartY + s1 * v2.y;
		//a2 = a2Start + s1 * omega2;
		a2 = a2Start + s1 * omega2;

		b2Conservative.R1.Set(a1);
		b2Conservative.R2.Set(a2);
		shape1.QuickSync(p1, b2Conservative.R1);
		shape2.QuickSync(p2, b2Conservative.R2);
	}

	if (hit)
	{
		// Hit, move bodies to safe position and re-sync shapes.
		//b2Vec2 d = b2Conservative.x2 - b2Conservative.x1;
		dX = b2Conservative.x2.x - b2Conservative.x1.x;
		dY = b2Conservative.x2.y - b2Conservative.x1.y;
		//float32 length = d.Length();
		var length = Math.sqrt(dX*dX + dY*dY);
		if (length &gt; FLT_EPSILON)
		{
			d *= b2_linearSlop / length;
		}

		if (body1.IsStatic())
		{
			//body1.m_position = p1;
			body1.m_position.x = p1X;
			body1.m_position.y = p1Y;
		}
		else
		{
			//body1.m_position = p1 - d;
			body1.m_position.x = p1X - dX;
			body1.m_position.y = p1Y - dY;
		}
		body1.m_rotation = a1;
		body1.m_R.Set(a1);
		body1.QuickSyncShapes();

		if (body2.IsStatic())
		{
			//body2-&gt;m_position = p2;
			body2.m_position.x = p2X;
			body2.m_position.y = p2Y;
		}
		else
		{
			//body2-&gt;m_position = p2 + d;
			body2.m_position.x = p2X + dX;
			body2.m_position.y = p2Y + dY;
		}
		//body2.m_position = p2 + d;
		body2.m_position.x = p2X + dX;
		body2.m_position.y = p2Y + dY;
		body2.m_rotation = a2;
		body2.m_R.Set(a2);
		body2.QuickSyncShapes();

		return true;
	}

	// No hit, restore shapes.
	shape1.QuickSync(body1.m_position, body1.m_R);
	shape2.QuickSync(body2.m_position, body2.m_R);
	return false;
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
